<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - LIA (LinkedIn Intelligence Agent)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }
        .hero-section {
            background-color: #0073b1;
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 4rem); /* Adjust for hero section */
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #f9f9f9;
        }
        .chat-input {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 1rem;
            border-top: 1px solid #ddd;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            max-width: 70%;
        }
        .message.user {
            background-color: #0073b1;
            color: white;
            margin-left: auto;
        }
        .message.ai {
            background-color: #e5e7eb;
            color: black;
            margin-right: auto;
        }
        .schedule-container {
            padding: 1rem;
            overflow-y: auto;
            height: calc(100vh - 4rem);
        }
        .tile {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .tile:hover {
            transform: scale(1.05);
        }
        .dropdown-menu {
            display: none;
        }
        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .active-menu {
            background-color: #2563eb !important;
        }
        .profile-dropdown {
            display: none;
        }
        .profile:hover .profile-dropdown {
            display: block;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        .hamburger {
            display: none;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
            }
            .sidebar-open {
                transform: translateX(0);
            }
            .hamburger {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Hero Section -->
    <div class="hero-section">
        <h1 class="text-3xl font-bold">LIA (LinkedIn Intelligence Agent)</h1>
        <p class="mt-1 text-md">Your AI assistant for LinkedIn tasks, powered by Datavalley</p>
        <!-- Profile Icon in Hero Section -->
        <div class="profile absolute top-4 right-4">
            <button class="text-white hover:text-gray-200 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A7.978 7.978 0 0112 14a7.978 7.978 0 016.879 3.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
            <div class="profile-dropdown absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">My Profile</a>
                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Settings</a>
                <a href="/logout" class="block px-4 py-2 text-red-600 hover:bg-gray-100">Logout</a>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex">
        <!-- Hamburger Menu -->
        <button class="hamburger p-4 text-gray-700 md:hidden" onclick="toggleSidebar()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-gray-800 text-white min-h-[calc(100vh-4rem)] p-4 sidebar">
            <nav>
                <ul>
                    <li class="mb-2">
                        <a href="#" class="block p-2 rounded hover:bg-gray-700 menu-item" data-section="home">Home</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block p-2 rounded hover:bg-gray-700 menu-item" data-section="agent-house">Agent House</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block p-2 rounded hover:bg-gray-700 menu-item" data-section="tools">Tools</a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="block p-2 rounded hover:bg-gray-700 menu-item" data-section="schedule">Schedule</a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-4">
            <!-- Home Section (Vertical Tiles) -->
            <div id="home-section" class="chat-container">
                <div class="flex flex-col gap-4 p-4">
                    <div class="tile bg-white shadow-lg rounded-lg p-4 cursor-pointer" data-section="chat">
                        <h3 class="text-lg font-semibold text-gray-800">Chat with LIA</h3>
                        <p class="text-gray-600">Interact with your LinkedIn Intelligence Agent.</p>
                    </div>
                    <div class="tile bg-white shadow-lg rounded-lg p-4 cursor-pointer" data-section="agent-house">
                        <h3 class="text-lg font-semibold text-gray-800">Agent House</h3>
                        <p class="text-gray-600">Manage your LinkedIn agents.</p>
                    </div>
                    <div class="tile bg-white shadow-lg rounded-lg p-4 cursor-pointer" data-section="tools">
                        <h3 class="text-lg font-semibold text-gray-800">Tools</h3>
                        <p class="text-gray-600">Access LinkedIn tools.</p>
                    </div>
                    <div class="tile bg-white shadow-lg rounded-lg p-4 cursor-pointer" data-section="schedule">
                        <h3 class="text-lg font-semibold text-gray-800">Schedule</h3>
                        <p class="text-gray-600">Manage your LinkedIn content schedule.</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chat-section" class="hidden chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">Hello! I'm LIA (LinkedIn Intelligence Agent). How can I assist you with LinkedIn today?</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">
                    <button onclick="sendMessage()" class="mt-2 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Send</button>
                </div>
            </div>

            <!-- Full Chat UI Section for LinkedIn Agent -->
            <div id="chat-full-section" class="hidden chat-container">
                <div class="chat-messages" id="chat-full-messages">
                    <div class="message ai">Hello! I'm LIA (LinkedIn Intelligence Agent). How can I assist you with LinkedIn today?</div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-full-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">
                    <button onclick="sendFullMessage()" class="mt-2 w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Send</button>
                </div>
            </div>

            <!-- Agent House Section -->
            <div id="agent-house-section" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-4">Agent House</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- LinkedIn Agent Tile -->
                    <div class="tile bg-white shadow-lg rounded-lg p-4 relative" data-agent="linkedin-agent">
                        <div class="dropdown absolute top-2 right-2">
                            <button class="text-gray-500 hover:text-gray-700 focus:outline-none">⋮</button>
                            <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 sub-option" data-section="under-progress">Manage Agent</a>
                                <a href="#" class="block px-4 py-2 text-red-600 hover:bg-gray-100 sub-option" data-section="under-progress">Delete</a>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">LinkedIn Agent</h3>
                        <p class="text-gray-600">Your AI assistant for LinkedIn tasks.</p>
                    </div>
                </div>
            </div>

            <!-- Tools Section -->
            <div id="tools-section" class="hidden p-4">
                <h2 class="text-2xl font-bold mb-4">Tools</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Content Creation Tool -->
                    <div class="tile bg-white shadow-lg rounded-lg p-4 relative">
                        <div class="dropdown absolute top-2 right-2">
                            <button class="text-gray-500 hover:text-gray-700 focus:outline-none">⋮</button>
                            <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 sub-option" data-section="under-progress">Manage Tool</a>
                                <a href="#" class="block px-4 py-2 text-red-600 hover:bg-gray-100 sub-option" data-section="under-progress">Delete</a>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Content Creation</h3>
                        <p class="text-gray-600">Generate engaging LinkedIn posts.</p>
                    </div>
                    <!-- Analytics Tool -->
                    <div class="tile bg-white shadow-lg rounded-lg p-4 relative">
                        <div class="dropdown absolute top-2 right-2">
                            <button class="text-gray-500 hover:text-gray-700 focus:outline-none">⋮</button>
                            <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 sub-option" data-section="under-progress">Manage Tool</a>
                                <a href="#" class="block px-4 py-2 text-red-600 hover:bg-gray-100 sub-option" data-section="under-progress">Delete</a>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Analytics</h3>
                        <p class="text-gray-600">Track your LinkedIn performance.</p>
                    </div>
                    <!-- Scheduling Tool -->
                    <div class="tile bg-white shadow-lg rounded-lg p-4 relative">
                        <div class="dropdown absolute top-2 right-2">
                            <button class="text-gray-500 hover:text-gray-700 focus:outline-none">⋮</button>
                            <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 sub-option" data-section="under-progress">Manage Tool</a>
                                <a href="#" class="block px-4 py-2 text-red-600 hover:bg-gray-100 sub-option" data-section="under-progress">Delete</a>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Scheduling</h3>
                        <p class="text-gray-600">Plan your LinkedIn posts.</p>
                    </div>
                    <!-- Posting Tool -->
                    <div class="tile bg-white shadow-lg rounded-lg p-4 relative">
                        <div class="dropdown absolute top-2 right-2">
                            <button class="text-gray-500 hover:text-gray-700 focus:outline-none">⋮</button>
                            <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg z-10">
                                <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 sub-option" data-section="under-progress">Manage Tool</a>
                                <a href="#" class="block px-4 py-2 text-red-600 hover:bg-gray-100 sub-option" data-section="under-progress">Delete</a>
                            </div>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-800">Posting</h3>
                        <p class="text-gray-600">Automate LinkedIn posting.</p>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule-section" class="hidden schedule-container">
                <h2 class="text-2xl font-bold mb-4">Schedule</h2>
                <table id="schedule-table" class="w-full border-collapse bg-white shadow-lg">
                    <thead>
                        <tr>
                            <th class="border p-2 bg-blue-600 text-white">Post Title</th>
                            <th class="border p-2 bg-blue-600 text-white">Content Type</th>
                            <th class="border p-2 bg-blue-600 text-white">Scheduled Date</th>
                            <th class="border p-2 bg-blue-600 text-white">Status</th>
                            <th class="border p-2 bg-blue-600 text-white">Draft Link</th>
                            <th class="border p-2 bg-blue-600 text-white">Notes</th>
                            <th class="border p-2 bg-blue-600 text-white">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in schedule %}
                        <tr data-record-id="{{ item.id }}">
                            <td class="border p-2 editable" data-field="Post title">{{ item.fields.get('Post title', 'N/A') }}</td>
                            <td class="border p-2 editable" data-field="Content type">
                                <span class="display">{{ item.fields.get('Content type', 'N/A') }}</span>
                                <select class="edit" style="display: none;">
                                    <option value="Post" {% if item.fields.get('Content type') == 'Post' %}selected{% endif %}>Post</option>
                                    <option value="Article" {% if item.fields.get('Content type') == 'Article' %}selected{% endif %}>Article</option>
                                    <option value="Poll" {% if item.fields.get('Content type') == 'Poll' %}selected{% endif %}>Poll</option>
                                </select>
                            </td>
                            <td class="border p-2 editable" data-field="Scheduled date">
                                <span class="display">{{ item.fields.get('Scheduled date', 'N/A') }}</span>
                                <input type="datetime-local" class="edit" style="display: none;" value="{{ item.fields.get('Scheduled date', '')|datetime_local }}">
                            </td>
                            <td class="border p-2 editable" data-field="Status">
                                <span class="display">{{ item.fields.get('Status', 'N/A') }}</span>
                                <select class="edit" style="display: none;">
                                    <option value="Draft" {% if item.fields.get('Status') == 'Draft' %}selected{% endif %}>Draft</option>
                                    <option value="Scheduled" {% if item.fields.get('Status') == 'Scheduled' %}selected{% endif %}>Scheduled</option>
                                    <option value="Posted" {% if item.fields.get('Status') == 'Posted' %}selected{% endif %}>Posted</option>
                                </select>
                            </td>
                            <td class="border p-2 editable" data-field="Draft link">
                                {% if item.fields.get('Draft link') %}
                                    <a href="{{ item.fields['Draft link'] }}" target="_blank">{{ item.fields['Draft link'] }}</a>
                                {% else %}
                                    N/A
                                {% endif %}
                                <input type="url" class="edit" style="display: none;" value="{{ item.fields.get('Draft link', '') }}">
                            </td>
                            <td class="border p-2 editable" data-field="Notes">{{ item.fields.get('Notes', 'N/A') }}</td>
                            <td class="border p-2">
                                <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 delete-btn" onclick="deleteRecord('{{ item.id }}')">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="mt-4 p-4 bg-white shadow-lg rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Add New Content</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="post_title" class="block text-gray-700 mb-1">Post Title:</label>
                            <input type="text" id="post_title" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="content_type" class="block text-gray-700 mb-1">Content Type:</label>
                            <select id="content_type" class="w-full p-2 border rounded-lg">
                                <option value="Post">Post</option>
                                <option value="Article">Article</option>
                                <option value="Poll">Poll</option>
                            </select>
                        </div>
                        <div>
                            <label for="scheduled_date" class="block text-gray-700 mb-1">Scheduled Date:</label>
                            <input type="datetime-local" id="scheduled_date" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label for="draft_link" class="block text-gray-700 mb-1">Draft Link (optional):</label>
                            <input type="url" id="draft_link" class="w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    <button onclick="addContent()" class="mt-4 w-full bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">Add Content</button>
                </div>
            </div>

            <!-- Under Progress Section -->
            <div id="under-progress-section" class="hidden p-4 flex flex-col items-center justify-center h-full">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Please enjoy nature while we get the things ready</h2>
                <img src="https://media.giphy.com/media/l0HlGmcMSxZ1N3e4g/giphy.gif" alt="Work in Progress Animation" class="w-64 h-64 mb-4">
                <p class="text-gray-600">This feature is under progress...</p>
            </div>
        </div>
    </div>

    <script>
        // Function to show a section and hide others
        function showSection(section) {
            document.querySelectorAll('#home-section, #chat-section, #chat-full-section, #agent-house-section, #tools-section, #schedule-section, #under-progress-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            document.getElementById(`${section}-section`).classList.remove('hidden');
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('sidebar-open');
        }

        // Highlight active menu item and persist section on refresh
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;

                // Highlight the active menu item
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active-menu'));
                this.classList.add('active-menu');

                // Show the selected section
                showSection(section);

                // Save the selected section to localStorage
                localStorage.setItem('activeSection', section);

                // Close sidebar on mobile after selection
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('sidebar-open');
            });
        });

        // Sub-options (Manage/Delete) navigation
        document.querySelectorAll('.sub-option').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                showSection(section);
                localStorage.setItem('activeSection', section);
            });
        });

        // Home section tiles navigation
        document.querySelectorAll('#home-section .tile').forEach(tile => {
            tile.addEventListener('click', function() {
                const section = this.dataset.section;
                showSection(section);
                localStorage.setItem('activeSection', section);

                // Highlight the corresponding menu item
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active-menu'));
                document.querySelector(`.menu-item[data-section="${section}"]`).classList.add('active-menu');
            });
        });

        // Restore the last selected section on page load
        window.addEventListener('load', function() {
            const activeSection = localStorage.getItem('activeSection') || 'home';
            showSection(activeSection);

            // Highlight the corresponding menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                if (item.dataset.section === activeSection) {
                    item.classList.add('active-menu');
                }
            });
        });

        // Chat functionality with LIA agent (regular chat)
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const messages = document.getElementById('chat-messages');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerText = message;
            messages.appendChild(userMessage);
            input.value = '';

            try {
                const response = await fetch('/lia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });
                const data = await response.json();
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                aiMessage.innerText = data.response;
                messages.appendChild(aiMessage);
            } catch (error) {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                aiMessage.innerText = 'Error: Unable to get a response from LIA.';
                messages.appendChild(aiMessage);
            }

            messages.scrollTop = messages.scrollHeight;
        }

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Chat functionality with LIA agent (full chat UI)
        async function sendFullMessage() {
            const input = document.getElementById('chat-full-input');
            const message = input.value.trim();
            if (!message) return;

            const messages = document.getElementById('chat-full-messages');
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerText = message;
            messages.appendChild(userMessage);
            input.value = '';

            try {
                const response = await fetch('/lia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });
                const data = await response.json();
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                aiMessage.innerText = data.response;
                messages.appendChild(aiMessage);
            } catch (error) {
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                aiMessage.innerText = 'Error: Unable to get a response from LIA.';
                messages.appendChild(aiMessage);
            }

            messages.scrollTop = messages.scrollHeight;
        }

        document.getElementById('chat-full-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendFullMessage();
            }
        });

        // Link LinkedIn Agent tile to full chat UI
        document.querySelectorAll('.tile[data-agent="linkedin-agent"]').forEach(tile => {
            tile.addEventListener('click', function(e) {
                // Prevent redirect if clicking the dropdown or its children
                if (e.target.closest('.dropdown') || e.target.closest('.dropdown-menu')) {
                    return;
                }
                showSection('chat-full');
                localStorage.setItem('activeSection', 'chat-full');

                // Highlight the "Agent House" menu item
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active-menu'));
                document.querySelector('.menu-item[data-section="agent-house"]').classList.add('active-menu');
            });
        });

        // In-line editing for schedule
        document.querySelectorAll('.editable').forEach(cell => {
            cell.addEventListener('click', function() {
                const display = this.querySelector('.display');
                const edit = this.querySelector('.edit');
                if (display && edit) {
                    display.style.display = 'none';
                    edit.style.display = 'block';
                    edit.focus();
                } else {
                    const value = this.innerText;
                    this.innerHTML = `<input type="text" class="edit" value="${value}">`;
                    this.querySelector('.edit').focus();
                }
            });
        });

        document.querySelectorAll('#schedule-table td').forEach(cell => {
            cell.addEventListener('focusout', function(e) {
                if (e.target.classList.contains('edit')) {
                    const recordId = this.parentElement.dataset.recordId;
                    const field = this.dataset.field;
                    const newValue = e.target.value;
                    const display = this.querySelector('.display');
                    const originalValue = display ? display.innerText : this.innerText;

                    if (display) {
                        display.style.display = 'block';
                        display.innerText = newValue;
                        e.target.style.display = 'none';
                    } else {
                        this.innerText = newValue;
                    }

                    const updatedData = {};
                    updatedData[field] = newValue;
                    fetch(`/update/${recordId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedData),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            console.error('Update failed:', data.error);
                            alert('Error updating record: ' + data.error);
                            if (display) {
                                display.innerText = originalValue;
                            } else {
                                this.innerText = originalValue;
                            }
                        } else {
                            if (field === 'Draft link' && data.record.fields['Draft link']) {
                                this.innerHTML = `<a href="${data.record.fields['Draft link']}" target="_blank">${data.record.fields['Draft link']}</a>`;
                                this.innerHTML += `<input type="url" class="edit" style="display: none;" value="${data.record.fields['Draft link']}">`;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                        alert('Error updating record: ' + error.message);
                        if (display) {
                            display.innerText = originalValue;
                        } else {
                            this.innerText = originalValue;
                        }
                    });
                }
            });

            cell.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.classList.contains('edit')) {
                    e.target.blur();
                }
            });
        });

        // Delete record
        function deleteRecord(recordId) {
            if (confirm('Are you sure you want to delete this record?')) {
                fetch(`/delete/${recordId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`tr[data-record-id="${recordId}"]`).remove();
                    } else {
                        alert('Error deleting record: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting record');
                });
            }
        }

        // Add new content via AJAX
        function addContent() {
            const postTitle = document.getElementById('post_title').value;
            const contentType = document.getElementById('content_type').value;
            const scheduledDate = document.getElementById('scheduled_date').value;
            const draftLink = document.getElementById('draft_link').value;

            if (!postTitle || !contentType || !scheduledDate) {
                alert('Please fill in all required fields');
                return;
            }

            const newRecord = {
                "Post title": postTitle,
                "Content type": contentType,
                "Scheduled date": scheduledDate,
                "Status": "Draft",
                "Draft link": draftLink,
                "Notes": "Generated by AI Agent"
            };

            fetch('/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(newRecord).toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const table = document.querySelector('#schedule-table tbody');
                    const newRow = document.createElement('tr');
                    newRow.dataset.recordId = data.record.id;
                    newRow.innerHTML = `
                        <td class="border p-2 editable" data-field="Post title">${data.record.fields['Post title'] || 'N/A'}</td>
                        <td class="border p-2 editable" data-field="Content type">
                            <span class="display">${data.record.fields['Content type'] || 'N/A'}</span>
                            <select class="edit" style="display: none;">
                                <option value="Post" ${data.record.fields['Content type'] === 'Post' ? 'selected' : ''}>Post</option>
                                <option value="Article" ${data.record.fields['Content type'] === 'Article' ? 'selected' : ''}>Article</option>
                                <option value="Poll" ${data.record.fields['Content type'] === 'Poll' ? 'selected' : ''}>Poll</option>
                            </select>
                        </td>
                        <td class="border p-2 editable" data-field="Scheduled date">
                            <span class="display">${data.record.fields['Scheduled date'] || 'N/A'}</span>
                            <input type="datetime-local" class="edit" style="display: none;" value="${data.record.fields['Scheduled date'] ? datetime_local(data.record.fields['Scheduled date']) : ''}">
                        </td>
                        <td class="border p-2 editable" data-field="Status">
                            <span class="display">${data.record.fields['Status'] || 'N/A'}</span>
                            <select class="edit" style="display: none;">
                                <option value="Draft" ${data.record.fields['Status'] === 'Draft' ? 'selected' : ''}>Draft</option>
                                <option value="Scheduled" ${data.record.fields['Status'] === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="Posted" ${data.record.fields['Status'] === 'Posted' ? 'selected' : ''}>Posted</option>
                            </select>
                        </td>
                        <td class="border p-2 editable" data-field="Draft link">
                            ${data.record.fields['Draft link'] ? `<a href="${data.record.fields['Draft link']}" target="_blank">${data.record.fields['Draft link']}</a>` : 'N/A'}
                            <input type="url" class="edit" style="display: none;" value="${data.record.fields['Draft link'] || ''}">
                        </td>
                        <td class="border p-2 editable" data-field="Notes">${data.record.fields['Notes'] || 'N/A'}</td>
                        <td class="border p-2">
                            <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 delete-btn" onclick="deleteRecord('${data.record.id}')">Delete</button>
                        </td>
                    `;
                    table.appendChild(newRow);
                    newRow.querySelectorAll('.editable').forEach(cell => {
                        cell.addEventListener('click', function() {
                            const display = this.querySelector('.display');
                            const edit = this.querySelector('.edit');
                            if (display && edit) {
                                display.style.display = 'none';
                                edit.style.display = 'block';
                                edit.focus();
                            } else {
                                const value = this.innerText;
                                this.innerHTML = `<input type="text" class="edit" value="${value}">`;
                                this.querySelector('.edit').focus();
                            }
                        });
                    });
                    newRow.querySelectorAll('td').forEach(cell => {
                        cell.addEventListener('focusout', function(e) {
                            if (e.target.classList.contains('edit')) {
                                const recordId = this.parentElement.dataset.recordId;
                                const field = this.dataset.field;
                                const newValue = e.target.value;
                                const display = this.querySelector('.display');
                                const originalValue = display ? display.innerText : this.innerText;

                                if (display) {
                                    display.style.display = 'block';
                                    display.innerText = newValue;
                                    e.target.style.display = 'none';
                                } else {
                                    this.innerText = newValue;
                                }

                                const updatedData = {};
                                updatedData[field] = newValue;
                                fetch(`/update/${recordId}`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(updatedData),
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (!data.success) {
                                        console.error('Update failed:', data.error);
                                        alert('Error updating record: ' + data.error);
                                        if (display) {
                                            display.innerText = originalValue;
                                        } else {
                                            this.innerText = originalValue;
                                        }
                                    } else {
                                        if (field === 'Draft link' && data.record.fields['Draft link']) {
                                            this.innerHTML = `<a href="${data.record.fields['Draft link']}" target="_blank">${data.record.fields['Draft link']}</a>`;
                                            this.innerHTML += `<input type="url" class="edit" style="display: none;" value="${data.record.fields['Draft link']}">`;
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error('Fetch error:', error);
                                    alert('Error updating record: ' + error.message);
                                    if (display) {
                                        display.innerText = originalValue;
                                    } else {
                                        this.innerText = originalValue;
                                    }
                                });
                            }
                        });

                        cell.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter' && e.target.classList.contains('edit')) {
                                e.target.blur();
                            }
                        });
                    });
                    document.getElementById('post_title').value = '';
                    document.getElementById('content_type').value = 'Post';
                    document.getElementById('scheduled_date').value = '';
                    document.getElementById('draft_link').value = '';
                } else {
                    alert('Error adding content: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding content');
            });
        }

        // Custom datetime_local function for JavaScript
        function datetime_local(isoDate) {
            if (!isoDate) return '';
            const dt = new Date(isoDate);
            return dt.toISOString().slice(0, 16);
        }
    </script>
</body>
</html>